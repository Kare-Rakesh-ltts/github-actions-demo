
name: Python HTML Diff

on:
  workflow_dispatch:

jobs:
  diff:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Create diff script
        shell: powershell
        run: |
          $script = @'
          #!/usr/bin/env python3
          import argparse, html, os, re, sys
          from difflib import HtmlDiff

          def read_text(p):
              if not os.path.exists(p): raise FileNotFoundError(f"File not found: {p}")
              return open(p, "r", encoding="utf-8", errors="replace").read()

          def write_text(p, s):
              os.makedirs(os.path.dirname(os.path.abspath(p)), exist_ok=True)
              open(p, "w", encoding="utf-8").write(s)

          def normalize_line_endings(t): return t.replace("\r\n","\n").replace("\r","\n")
          def normalize_whitespace(t):
              t = normalize_line_endings(t)
              t = re.sub(r"[ \t]+"," ", t)
              return "\n".join(line.rstrip() for line in t.split("\n"))

          def canonicalize_xml(t):
              t = normalize_line_endings(t)
              try:
                  from xml.etree import ElementTree as ET
                  root = ET.fromstring(t)
              except Exception:
                  return normalize_whitespace(t)
              def _ws(s): return re.sub(r"\s+"," ", s).strip()
              def _norm(n):
                  if n.text is not None: n.text = _ws(n.text)
                  if n.tail is not None: n.tail = _ws(n.tail)
                  if n.attrib:
                      items = sorted(n.attrib.items(), key=lambda kv: kv[0])
                      n.attrib.clear()
                      for k,v in items: n.attrib[k] = v
                  for c in list(n): _norm(c)
              _norm(root)
              return _serialize_compact(root)

          def _serialize_compact(elem):
              def esc(s): return (s.replace("&","&amp;").replace("<","&lt;").replace(">","&gt;").replace('"',"&quot;"))
              def attrs_str(a):
                  return "" if not a else " " + " ".join(f'{k}="{esc(v)}"' for k,v in a.items())
              def node_str(n):
                  start = f"<{n.tag}{attrs_str(n.attrib)}>"
                  end = f"</{n.tag}>"
                  text = esc(n.text or "")
                  kids = "".join(node_str(c) for c in list(n))
                  return f"{start}{text}{kids}{end}"
              s = node_str(elem)
              return re.sub(r">(</)", ">\n</", s)

              # (Note: simple compact XML output for deterministic diff.)

          def make_html_diff(a, b, la, lb, full, ctx, wrap):
              d = HtmlDiff(tabsize=4, wrapcolumn=(wrap if wrap and wrap>0 else None))
              return d.make_file(a.splitlines(), b.splitlines(), la, lb, context=not full, numlines=(ctx if not full else 0))

          def post(html_str, title, remove_h1):
              if title:
                  safe = html.escape(title, quote=False)
                  html_str = re.sub(r"(?is)(<title>).*?(</title>)", rf"\\1{safe}\\2", html_str, count=1)
              if remove_h1:
                  html_str = re.sub(r"(?is)<h1[^>]*>.*?</h1>", "", html_str, count=1)
              return html_str

          def parse(argv):
              p = argparse.ArgumentParser(description="Generate HTML side-by-side diff.")
              p.add_argument("--left", required=True)
              p.add_argument("--right", required=True)
              p.add_argument("--out", required=True)
              p.add_argument("--full-context", action="store_true")
              p.add_argument("--context-lines", type=int, default=3)
              p.add_argument("--wrap-column", type=int, default=120)
              p.add_argument("--ignore-whitespace", action="store_true")
              p.add_argument("--xml-canonicalize", action="store_true")
              p.add_argument("--title", default=None)
              p.add_argument("--remove-body-h1", action="store_true")
              return p.parse_args(argv)

          def main():
              args = parse(sys.argv[1:])
              left_raw = read_text(args.left)
              right_raw = read_text(args.right)
              if args.xml_canonicalize:
                  left_norm = canonicalize_xml(left_raw)
                  right_norm = canonicalize_xml(right_raw)
              elif args.ignore_whitespace:
                  left_norm = normalize_whitespace(left_raw)
                  right_norm = normalize_whitespace(right_raw)
              else:
                  left_norm = normalize_line_endings(left_raw)
                  right_norm = normalize_line_endings(right_raw)

              la = os.path.basename(args.left)
              lb = os.path.basename(args.right)
              html_str = make_html_diff(left_norm, right_norm, la, lb, args.full_context, args.context_lines, args.wrap_column)
              html_str = post(html_str, args.title, args.remove_body_h1)
              write_text(args.out, html_str)
              print(f"âœ” Diff HTML written to: {args.out}")

          if __name__ == "__main__":
              main()
          '@
          Set-Content -Path "$env:GITHUB_WORKSPACE\generate_diff.py" -Value $script -Encoding UTF8

      - name: Generate HTML diff
        shell: powershell
        run: |
          python "$env:GITHUB_WORKSPACE\generate_diff.py" `
            --left "Files\ExampleComponent_v1.arxml" `
            --right "Files\ExampleComponent_v2.arxml" `
            --out "diff.html" `
            --full-context `
            --xml-canonicalize `
            --title "ARXML Diff (Python)" `
            --remove-body-h1

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-diff
          path: diff.html
