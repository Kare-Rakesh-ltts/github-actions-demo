
name: svn-sync-action

on:
  workflow_dispatch:

jobs:
  sync:
    runs-on: self-hosted

    steps:
      - name: Clone public repo without token
        shell: powershell
        run: |
          if (Test-Path 'demo-repo') {
              Remove-Item 'demo-repo' -Recurse -Force
          }
          git clone --depth 1 https://github.com/Kare-Rakesh-ltts/github-actions-demo.git demo-repo
          dir demo-repo

      - name: Ensure SVN is installed
        shell: powershell
        run: |
          if (-not (Get-Command svn.exe -ErrorAction SilentlyContinue)) {
            Write-Host "ERROR: svn.exe not found. Install Subversion CLI (e.g., via TortoiseSVN CLI or Chocolatey)."
            exit 1
          }
          svn --version

      - name: Build commit message
        shell: powershell
        run: |
          $msg = "Automated sync from $env:COMPUTERNAME on $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
          Add-Content -Path $env:GITHUB_ENV -Value "COMMIT_MESSAGE=$msg"
          Write-Host "Set COMMIT_MESSAGE env: $msg"

      - name: Run Python sync script
        shell: powershell
        working-directory: demo-repo
        env:
          SOURCE_PATH: 'C:\Users\40018941\Downloads\HONDA-DOC'
          SVN_URL: 'svn://100.127.6.223/CREATE_SVN_REPO/trunk'
          SVN_USERNAME: ${{ secrets.SVN_USERNAME }}
          SVN_PASSWORD: ${{ secrets.SVN_PASSWORD }}
          COMMIT_MESSAGE: ${{ env.COMMIT_MESSAGE }}
        run: |
          Write-Host "COMMIT_MESSAGE (env): $env:COMMIT_MESSAGE"
          python scripts/svn_copy_and_commit.py
