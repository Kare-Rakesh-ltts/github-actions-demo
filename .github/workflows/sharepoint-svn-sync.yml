
name: sync-sharepoint-svn

on:
  workflow_dispatch: {}

jobs:
  sync:
    runs-on: [self-hosted]

    steps:
      - name: Clone public repo without token
        shell: powershell
        run: |
          if (Test-Path 'repo') {
            Remove-Item 'repo' -Recurse -Force
          }
          git clone --depth 1 https://github.com/Kare-Rakesh-ltts/github-actions-demo.git repo

      - name: Prepare Python env and install deps
        shell: powershell
        run: |
          python -m pip --version
          python -m pip install --upgrade pip
          python -m pip install msal requests

      - name: Download 'CICD_Automation' from SharePoint
        shell: powershell
        working-directory: repo
        env:
          GRAPH_TENANT_ID: ${{ secrets.GRAPH_TENANT_ID }}
          GRAPH_CLIENT_ID: ${{ secrets.GRAPH_CLIENT_ID }}
          GRAPH_CLIENT_SECRET: ${{ secrets.GRAPH_CLIENT_SECRET }}
        run: |
          python ".\scripts\sharepoint_svn_sync.py"

      - name: SVN checkout working copy (under repo)
        shell: powershell
        working-directory: repo
        env:
          SVN_USERNAME: ${{ secrets.SVN_USERNAME }}
          SVN_PASSWORD: ${{ secrets.SVN_PASSWORD }}
        run: |
          $svnUrl = "svn://172.17.110.132/CREATE_SVN_REPO/trunk"
          Write-Host "Cleaning previous working copy in repo..."
          if (Test-Path ".\svn_wc") { Remove-Item ".\svn_wc" -Recurse -Force }
          New-Item -ItemType Directory -Path ".\svn_wc" | Out-Null

          if ($env:SVN_USERNAME -and $env:SVN_PASSWORD) {
            svn checkout "$svnUrl" ".\svn_wc" --non-interactive --username "$env:SVN_USERNAME" --password "$env:SVN_PASSWORD" --no-auth-cache
          } else {
            svn checkout "$svnUrl" ".\svn_wc" --non-interactive
          }

      - name: Sync files into SVN working copy
        working-directory: repo
        shell: powershell
        run: |
          $src = ".\sharepoint_sync\CICD_Automation"
          $dst = ".\svn_wc\CICD_Automation"

          if (!(Test-Path $dst)) { New-Item -ItemType Directory -Path $dst | Out-Null }
          if (!(Test-Path $src)) { throw "Source path not found: $src" }

          # Mirror source to SVN working copy, but do NOT touch .svn
          robocopy $src $dst /MIR /XD ".svn" /NFL /NDL /NP /R:1 /W:1 | Out-Null

          $code = $LASTEXITCODE
          Write-Host "Robocopy exit code: $code"
          if ($code -le 7) {
            $global:LASTEXITCODE = 0
          } else {
            throw "Robocopy failed with exit code $code"
          }

      - name: Stage add/remove and commit to SVN
        shell: powershell
        working-directory: repo
        env:
          SVN_USERNAME: ${{ secrets.SVN_USERNAME }}
          SVN_PASSWORD: ${{ secrets.SVN_PASSWORD }}
        run: |
          Set-Location ".\svn_wc"

          # Ensure this IS a working copy
          svn info

          # Remove missing files ('!' status)
          svn status | ForEach-Object {
            if ($_ -match '^\!\s+(.*)$') {
              $path = $Matches[1]
              svn rm --force "$path"
            }
          }

          # Add unknown files ('?' status)
          svn status | ForEach-Object {
            if ($_ -match '^\?\s+(.*)$') {
              $path = $Matches[1]
              svn add --force --parents "$path"
            }
          }

          $COMMIT_MSG = "commit files from share point to svn"
          if ($env:SVN_USERNAME -and $env:SVN_PASSWORD) {
            svn commit -m "$COMMIT_MSG" --non-interactive --username "$env:SVN_USERNAME" --password "$env:SVN_PASSWORD" --no-auth-cache
          } else {
            svn commit -m "$COMMIT_MSG" --non-interactive
          }
